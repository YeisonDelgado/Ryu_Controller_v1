<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SDN NSFNET Control</title>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Control de Red NSFNET</h1>
        <!-- Control del Sistema -->
        <fieldset class="border p-4 mb-4">
            <legend class="float-none w-auto px-3 h2 text-primary">Estado del Sistema</legend>
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            Servicios
                        </div>
                        <div class="card-body">
                            <p><strong>Ryu Controller:</strong> <span id="ryu-status" class="badge bg-secondary">Desconocido</span></p>
                            <p><strong>NSFNET:</strong> <span id="mininet-status" class="badge bg-secondary">Desconocido</span></p>
                            <button id="refresh-status" class="btn btn-outline-info btn-sm">Actualizar Estado</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            Control
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button id="start-system" class="btn btn-success">Iniciar Sistema</button>
                                <button id="stop-system" class="btn btn-danger">Detener Sistema</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="system-status-message" class="alert mt-3" style="display: none;"></div>
        </fieldset>

        <!-- Routing Control -->
        <fieldset class="border p-4 mb-4">
            <legend class="float-none w-auto px-3 h2 text-success">Control de Routing</legend>
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Algoritmo de Routing</div>
                        <div class="card-body">
                            <select id="routing-select" class="form-select mb-3">
                                <option value="dijkstra_bw">Dijkstra (1/bandwidth)</option>
                                <option value="shortest_hops">Shortest Path (hops)</option>
                            </select>
                            <button id="apply-routing" class="btn btn-primary">Aplicar Algoritmo</button>
                            <div class="mt-3">
                                <p class="text-muted small">
                                    <strong>Dijkstra (1/bandwidth):</strong> Selecciona rutas optimizando el ancho de banda disponible.<br>
                                    <strong>Shortest Path (hops):</strong> Selecciona rutas minimizando el número de saltos.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">Estado del Routing</div>
                        <div class="card-body">
                            <p id="routing-status" class="text-muted">Estado: pendiente</p>
                            <div id="routing-details" class="small">
                                <!-- Aquí se mostrarán los detalles del routing -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>

        <!-- Network Topology -->
        <fieldset class="border p-4">
            <legend class="float-none w-auto px-3 h2 text-info">Topología NSFNET</legend>
            <div class="row mb-3">
                <div class="col-md-6">
                    <button id="load-topology" class="btn btn-primary">Actualizar Topología</button>
                </div>
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="show-bandwidth">
                        <label class="form-check-label" for="show-bandwidth">Mostrar ancho de banda en enlaces</label>
                    </div>
                </div>
            </div>
            <div id="cy" style="height: 500px; border: 1px solid #ccc;">
                <!-- Aquí se cargará la topología -->
            </div>
            <div class="mt-3">
                <p class="text-muted small">
                    <span class="badge bg-primary">■</span> Switch &nbsp;
                    <span class="badge bg-success">■</span> Host &nbsp;
                    Los números en los enlaces indican el ancho de banda (Mbps)
                </p>
            </div>
        </fieldset>
    </div>

    <script>
        // Utility Functions
        function showMessage(message, type = 'info') {
            const statusElement = document.getElementById('system-status-message');
            statusElement.className = `alert alert-${type} mt-3`;
            statusElement.style.display = 'block';
            statusElement.textContent = message;
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        function updateStatusBadge(elementId, isActive) {
            const badge = document.getElementById(elementId);
            badge.className = `badge ${isActive ? 'bg-success' : 'bg-danger'}`;
            badge.textContent = isActive ? 'Activo' : 'Inactivo';
        }

        // System Status
        async function updateSystemStatus() {
            try {
                const response = await fetch('http://localhost:8000/status');
                const status = await response.json();
                updateStatusBadge('ryu-status', status.ryu);
                updateStatusBadge('mininet-status', status.mininet);
            } catch (error) {
                console.error('Error al actualizar estado:', error);
            }
        }

        // System Control
        document.getElementById('start-system').addEventListener('click', async () => {
            try {
                showMessage('Iniciando sistema...', 'info');
                const response = await fetch('http://localhost:8000/start-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_name: 'simple_switch_13.py',
                        topology_file: 'nsfnet.py'
                    })
                });
                const data = await response.json();
                showMessage(data.message, 'success');
                updateSystemStatus();
                // Cargamos la topología automáticamente al iniciar
                setTimeout(loadAndDisplayTopology, 5000);
            } catch (error) {
                showMessage('Error al iniciar el sistema: ' + error.message, 'danger');
            }
        });

        document.getElementById('stop-system').addEventListener('click', async () => {
            try {
                showMessage('Deteniendo sistema...', 'info');
                const response = await fetch('http://localhost:8000/stop-all', {
                    method: 'POST'
                });
                const data = await response.json();
                showMessage(data.message, 'success');
                updateSystemStatus();
            } catch (error) {
                showMessage('Error al detener el sistema: ' + error.message, 'danger');
            }
        });

        // Routing Control
        async function updateRoutingStatus() {
            try {
                const response = await fetch('http://localhost:8000/routing/status');
                const data = await response.json();
                const statusEl = document.getElementById('routing-status');
                const detailsEl = document.getElementById('routing-details');
                
                statusEl.innerText = `Modo actual: ${data.mode === 'dijkstra_bw' ? 'Dijkstra (1/bandwidth)' : 'Shortest Path (hops)'}`;
                
                // Mostrar algunas rutas como ejemplo
                if (data.routes) {
                    const routesList = Object.entries(data.routes).slice(0, 5);
                    detailsEl.innerHTML = '<h6 class="mt-3">Algunas rutas calculadas:</h6>' +
                        '<ul class="list-unstyled small">' +
                        routesList.map(([path, route]) => `<li>${path}: ${route.join(' → ')}</li>`).join('') +
                        '</ul>';
                }
            } catch (error) {
                console.error('Error al actualizar estado del routing:', error);
            }
        }

        document.getElementById('apply-routing').addEventListener('click', async () => {
            const mode = document.getElementById('routing-select').value;
            document.getElementById('routing-status').innerText = 'Aplicando algoritmo...';
            try {
                const response = await fetch('http://localhost:8000/routing/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                const data = await response.json();
                showMessage(data.message, 'success');
                updateRoutingStatus();
            } catch (error) {
                showMessage('Error: ' + error.message, 'danger');
            }
        });

        // Topology Visualization
        let cy = null;
        
        async function loadAndDisplayTopology() {
            try {
                const [linksRes, hostsRes] = await Promise.all([
                    fetch('http://localhost:8000/v1.0/topology/links'),
                    fetch('http://localhost:8000/v1.0/topology/hosts')
                ]);
                
                const links = await linksRes.json();
                const hosts = await hostsRes.json();

                const elements = [];
                const nodeSet = new Set();
                const edgeSet = new Set();

                // Process switches and links
                links.forEach(link => {
                    const srcId = link.src.dpid;
                    const dstId = link.dst.dpid;
                    
                    if (!nodeSet.has(srcId)) {
                        elements.push({
                            data: {
                                id: srcId,
                                label: `S${parseInt(srcId, 16)}`,
                                type: 'switch'
                            }
                        });
                        nodeSet.add(srcId);
                    }
                    
                    if (!nodeSet.has(dstId)) {
                        elements.push({
                            data: {
                                id: dstId,
                                label: `S${parseInt(dstId, 16)}`,
                                type: 'switch'
                            }
                        });
                        nodeSet.add(dstId);
                    }

                    const edgeId = `${srcId}-${dstId}`;
                    if (!edgeSet.has(edgeId)) {
                        elements.push({
                            data: {
                                id: edgeId,
                                source: srcId,
                                target: dstId,
                                bandwidth: link.bw || 'N/A'
                            }
                        });
                        edgeSet.add(edgeId);
                    }
                });

                // Process hosts
                hosts.forEach(host => {
                    const hostId = `h-${host.mac}`;
                    elements.push({
                        data: {
                            id: hostId,
                            label: `H${host.mac.slice(-2)}`,
                            type: 'host'
                        }
                    });

                    elements.push({
                        data: {
                            id: `${hostId}-${host.port.dpid}`,
                            source: hostId,
                            target: host.port.dpid
                        }
                    });
                });

                if (cy) {
                    cy.destroy();
                }

                const showBandwidth = document.getElementById('show-bandwidth').checked;

                cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(label)',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'font-size': '12px',
                                'width': '40px',
                                'height': '40px',
                                'color': '#fff'
                            }
                        },
                        {
                            selector: 'node[type="switch"]',
                            style: {
                                'background-color': '#0074D9',
                                'shape': 'rectangle'
                            }
                        },
                        {
                            selector: 'node[type="host"]',
                            style: {
                                'background-color': '#2ECC40',
                                'shape': 'ellipse'
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 2,
                                'line-color': '#666',
                                'curve-style': 'bezier',
                                'label': showBandwidth ? 'data(bandwidth)' : '',
                                'font-size': '10px'
                            }
                        }
                    ],
                    layout: {
                        name: 'cose',
                        padding: 50,
                        nodeRepulsion: 8000,
                        idealEdgeLength: 100
                    }
                });

            } catch (error) {
                showMessage('Error al cargar la topología: ' + error.message, 'danger');
            }
        }

        // Event Listeners
        document.getElementById('refresh-status').addEventListener('click', updateSystemStatus);
        document.getElementById('load-topology').addEventListener('click', loadAndDisplayTopology);
        document.getElementById('show-bandwidth').addEventListener('change', loadAndDisplayTopology);

        // Initial load
        updateSystemStatus();
        setInterval(updateSystemStatus, 10000);
        setInterval(updateRoutingStatus, 5000);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>